name: Deploy to Azure VM

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allows manual trigger

jobs:
  test:
    name: Test Backend
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install backend dependencies
      run: |
        cd backend
        pip install -r requirements.txt
    
    - name: Run backend tests
      run: |
        cd backend
        pytest test_server.py -v
    
    - name: Run backend linting
      run: |
        cd backend
        flake8 server.py --max-line-length=120 --ignore=E402,W503 || echo "âš ï¸ Linting warnings found"

  deploy:
    name: Deploy to Azure VM
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.AZURE_VM_SSH_KEY }}" > ~/.ssh/azure_key
        chmod 600 ~/.ssh/azure_key
        ssh-keyscan -H ${{ secrets.AZURE_VM_HOST }} >> ~/.ssh/known_hosts
    
    - name: Deploy to Azure VM
      run: |
        ssh -i ~/.ssh/azure_key ${{ secrets.AZURE_VM_USERNAME }}@${{ secrets.AZURE_VM_HOST }} << 'ENDSSH'
          cd /home/azureuser/truth-quest
          
          echo "ðŸ“¥ Pulling latest code..."
          git pull origin main
          
          echo "ðŸ”§ Setting up backend..."
          cd backend
          
          # Create .env with secrets
          cat > .env << 'EOF'
        ENDSSH
        
        # Inject secrets separately to avoid shell interpolation issues
        ssh -i ~/.ssh/azure_key ${{ secrets.AZURE_VM_USERNAME }}@${{ secrets.AZURE_VM_HOST }} << ENDSSH
          cd /home/azureuser/truth-quest/backend
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env
          echo "BRAVE_API_KEY=${{ secrets.BRAVE_API_KEY }}" >> .env
          echo "YOUTUBE_API_KEY=${{ secrets.YOUTUBE_API_KEY }}" >> .env
          echo "PORT=3001" >> .env
          echo "GOOGLE_APPLICATION_CREDENTIALS=./serviceAccountKey.json" >> .env
          
          source venv/bin/activate
          pip install -r requirements.txt --quiet
          
          echo "ðŸ”§ Building frontend..."
          cd ../frontend
          npm install --silent
          npm run build
          
          echo "ðŸ”„ Restarting services..."
          sudo systemctl restart truth-quest-backend
          sudo systemctl restart nginx
          
          echo "âœ… Deployment complete!"
        ENDSSH
          
    - name: Verify Deployment
      run: |
        sleep 10
        echo "âœ… Deployment successful!"
        echo "Frontend: http://${{ secrets.AZURE_VM_HOST }}"
        echo "Backend: http://${{ secrets.AZURE_VM_HOST }}:3001"
