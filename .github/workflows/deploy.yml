name: Deploy to Azure VM

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allows manual trigger

jobs:
  test:
    name: Test Backend
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install backend dependencies
      run: |
        cd backend
        pip install -r requirements.txt
    
    - name: Run backend tests
      run: |
        cd backend
        pytest test_server.py -v
    
    - name: Run backend linting
      run: |
        cd backend
        flake8 server.py --max-line-length=120 --ignore=E402,W503 || echo "âš ï¸ Linting warnings found"

  deploy:
    name: Deploy to Azure VM
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup SSH
      env:
        SSH_KEY: ${{ secrets.AZURE_VM_SSH_KEY }}
        VM_HOST: ${{ secrets.AZURE_VM_HOST }}
        VM_USER: ${{ secrets.AZURE_VM_USERNAME }}
      run: |
        echo "ðŸ”‘ Setting up SSH connection..."
        echo "VM Host: $VM_HOST"
        echo "VM User: $VM_USER"
        
        # Check if secrets are set
        if [ -z "$VM_HOST" ]; then
          echo "âŒ ERROR: AZURE_VM_HOST secret is not set!"
          exit 1
        fi
        
        if [ -z "$VM_USER" ]; then
          echo "âŒ ERROR: AZURE_VM_USERNAME secret is not set!"
          echo "Please add it in: GitHub Repo â†’ Settings â†’ Secrets and variables â†’ Actions"
          echo "Secret name: AZURE_VM_USERNAME"
          echo "Secret value: azureuser (or your VM username)"
          exit 1
        fi
        
        if [ -z "$SSH_KEY" ]; then
          echo "âŒ ERROR: AZURE_VM_SSH_KEY secret is not set!"
          exit 1
        fi
        
        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/azure_key
        chmod 600 ~/.ssh/azure_key
        echo "âœ… SSH key configured"
        
        echo "ðŸ” Adding VM to known hosts..."
        ssh-keyscan -H $VM_HOST >> ~/.ssh/known_hosts 2>&1
        echo "âœ… Known hosts updated"
        
        echo "ðŸ§ª Testing SSH connection..."
        ssh -i ~/.ssh/azure_key -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "echo 'âœ… SSH connection successful'"
    
    - name: Pull Latest Code
      env:
        VM_HOST: ${{ secrets.AZURE_VM_HOST }}
        VM_USER: ${{ secrets.AZURE_VM_USERNAME }}
      run: |
        echo "ðŸ“¥ Pulling latest code from repository..."
        ssh -i ~/.ssh/azure_key -o StrictHostKeyChecking=no $VM_USER@$VM_HOST << 'ENDSSH'
          set -e
          cd /home/azureuser/truth-quest
          echo "Current directory: $(pwd)"
          
          # Stash any local changes to avoid conflicts
          echo "ðŸ”„ Stashing any local changes..."
          git stash
          
          # Pull latest code
          git pull origin main
          
          echo "âœ… Code updated successfully"
        ENDSSH
    
    - name: Create Environment File
      env:
        VM_HOST: ${{ secrets.AZURE_VM_HOST }}
        VM_USER: ${{ secrets.AZURE_VM_USERNAME }}
        OPENAI_KEY: ${{ secrets.OPENAI_API_KEY }}
        BRAVE_KEY: ${{ secrets.BRAVE_API_KEY }}
        YOUTUBE_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
      run: |
        echo "ðŸ”§ Creating .env file with secrets..."
        ssh -i ~/.ssh/azure_key -o StrictHostKeyChecking=no $VM_USER@$VM_HOST << ENDSSH
          set -e
          cd /home/azureuser/truth-quest/backend
          echo "OPENAI_API_KEY=$OPENAI_KEY" > .env
          echo "BRAVE_API_KEY=$BRAVE_KEY" >> .env
          echo "YOUTUBE_API_KEY=$YOUTUBE_KEY" >> .env
          echo "RAPIDAPI_KEY=$RAPIDAPI_KEY" >> .env
          echo "PORT=3001" >> .env
          echo "GOOGLE_APPLICATION_CREDENTIALS=./serviceAccountKey.json" >> .env
          echo "âœ… Environment file created"
        ENDSSH
    
    - name: Install Backend Dependencies
      env:
        VM_HOST: ${{ secrets.AZURE_VM_HOST }}
        VM_USER: ${{ secrets.AZURE_VM_USERNAME }}
      run: |
        echo "ðŸ“¦ Installing backend dependencies..."
        ssh -i ~/.ssh/azure_key -o StrictHostKeyChecking=no $VM_USER@$VM_HOST << 'ENDSSH'
          set -e
          cd /home/azureuser/truth-quest/backend
          source venv/bin/activate
          pip install -r requirements.txt --quiet
          echo "âœ… Backend dependencies installed"
        ENDSSH
    
    - name: Build Frontend
      env:
        VM_HOST: ${{ secrets.AZURE_VM_HOST }}
        VM_USER: ${{ secrets.AZURE_VM_USERNAME }}
      run: |
        echo "ðŸ—ï¸ Building frontend..."
        ssh -i ~/.ssh/azure_key -o StrictHostKeyChecking=no $VM_USER@$VM_HOST << 'ENDSSH'
          set -e
          cd /home/azureuser/truth-quest/frontend
          npm install --silent
          npm run build
          echo "âœ… Frontend built successfully"
        ENDSSH
    
    - name: Restart Services
      env:
        VM_HOST: ${{ secrets.AZURE_VM_HOST }}
        VM_USER: ${{ secrets.AZURE_VM_USERNAME }}
      run: |
        echo "ðŸ”„ Restarting services..."
        ssh -i ~/.ssh/azure_key -o StrictHostKeyChecking=no $VM_USER@$VM_HOST << 'ENDSSH'
          set -e
          sudo systemctl restart truth-quest-backend
          echo "âœ… Backend service restarted"
          sudo systemctl restart nginx
          echo "âœ… Nginx restarted"
          
          # Wait a moment for services to start
          sleep 3
          
          # Check service status
          echo "ðŸ“Š Service status:"
          sudo systemctl is-active truth-quest-backend || echo "âš ï¸ Backend service not active"
          sudo systemctl is-active nginx || echo "âš ï¸ Nginx not active"
        ENDSSH
          
    - name: Verify Deployment
      env:
        VM_HOST: ${{ secrets.AZURE_VM_HOST }}
      run: |
        echo "â³ Waiting for services to stabilize..."
        sleep 5
        
        echo ""
        echo "âœ… Deployment Complete!"
        echo "================================"
        echo "Frontend: http://$VM_HOST"
        echo "Backend API: http://$VM_HOST:3001"
        echo "Health Check: http://$VM_HOST:3001/api/health"
        echo "================================"
